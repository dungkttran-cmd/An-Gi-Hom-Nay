<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ƒÇn g√¨ h√¥m nay? ‚Äî Pro v3 (Geocoding)</title>
<style>
:root{--accent:#ff7b2d;--bg:#fff6ee;--card:#fff;--muted:#8b6b57;--shadow:0 8px 24px rgba(0,0,0,0.06);}
*{box-sizing:border-box}
body{font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:#2b2b2b;margin:0;padding:0}
.header{background:#fff;padding:18px 24px;border-bottom:1px solid #f0e6de;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40}
.title{color:var(--accent);font-weight:800;font-size:22px}
.container{max-width:1240px;margin:18px auto;padding:0 18px}
.topbar{background:var(--card);padding:14px;border-radius:10px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center}
.loc-btn{background:#27ae60;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;display:flex;gap:8px;align-items:center}
.input{flex:1;display:flex;gap:8px;align-items:center}
.input input{flex:1;padding:12px 14px;border-radius:8px;border:1px solid #eee;background:#faf7f6}
.input button{padding:10px 12px;border-radius:8px;border:none;background:#9aa0a6;color:#fff;cursor:pointer}
.tabs{display:flex;gap:12px;margin-top:16px}
.tab{flex:1;padding:14px;border-radius:8px;background:#fdebd6;text-align:center;cursor:pointer;border:1px solid #f5ded0;display:flex;align-items:center;justify-content:center;gap:8px}
.tab.active{background:var(--accent);color:#fff}
.main{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px;align-items:start}
.left{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.card{background:#fff;border-radius:10px;padding:12px;border:1px solid #f0e6de;box-shadow:0 2px 6px rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:8px;height:170px}
.cardTop{display:flex;gap:10px;align-items:center}
.thumb{width:120px;height:86px;border-radius:8px;flex-shrink:0;background:#eee;overflow:hidden;display:flex;align-items:center;justify-content:center}
.info{flex:1;display:flex;flex-direction:column;justify-content:space-between}
.info h4{margin:0;font-size:16px;color:#d35400}
.info .sub{color:var(--muted);font-size:13px}
.meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
.meta .price{color:var(--accent);font-weight:700}
.meta .dist{color:#2d7a2d;font-weight:600;font-size:13px}
.controls{display:flex;justify-content:flex-end;margin-top:12px;gap:8px}
.right{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);position:relative;top:0;height:calc(100vh - 140px);overflow:auto}
.promo{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;border-left:4px solid var(--accent)}
.btn-like{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.view-more{display:block;margin:12px auto;padding:10px 14px;border-radius:8px;background:#eee;border:none;cursor:pointer}
.footer-note{margin-top:12px;color:#7a6a5b;font-size:13px;text-align:center}
.loading{color:#999;font-size:13px;padding:8px;background:#fff;border-radius:8px;border:1px solid #f0e6de;margin-bottom:10px}

/* Responsive */
@media (max-width:1100px){
  .grid{grid-template-columns:repeat(2,1fr)}
  .main{grid-template-columns:1fr}
  .right{height:auto;max-height:360px}
}
@media (max-width:600px){
  .grid{grid-template-columns:1fr}
  .thumb{width:90px;height:66px}
  .card{height:auto}
  .title{font-size:18px}
  .input input{padding:10px}
}
</style>
</head>
<body>
  <div class="header">
    <div class="title">ƒÇn g√¨ h√¥m nay?</div>
    <div class="small">Pro v3 ‚Äî Geocoding ON</div>
  </div>

  <div class="container">
    <div class="topbar">
      <button class="loc-btn" onclick="getUserLocation()">üìç L·∫•y v·ªã tr√≠ hi·ªán t·∫°i</button>
      <div class="input">
        <input id="manualAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c khu v·ª±c (v√≠ d·ª•: Frankfurt, Germany ho·∫∑c H√† N·ªôi, Vi·ªát Nam)" />
        <button onclick="useManualAddress()">T√¨m</button>
      </div>
      <div style="width:120px;display:flex;justify-content:flex-end">
        <button onclick="refreshAll()" class="btn-like">L√†m m·ªõi</button>
      </div>
    </div>

    <div class="tabs" style="margin-top:18px">
      <div id="tab-morning" class="tab" onclick="selectMeal('morning')">üåÖ Bu·ªïi s√°ng</div>
      <div id="tab-lunch" class="tab active" onclick="selectMeal('lunch')">‚òÄÔ∏è Bu·ªïi tr∆∞a</div>
      <div id="tab-dinner" class="tab" onclick="selectMeal('dinner')">üåô Bu·ªïi t·ªëi</div>
    </div>

    <div class="main">
      <div class="left">
        <h2 id="mealTitle">Bu·ªïi tr∆∞a</h2>
        <div id="status" class="small">T√¨nh tr·∫°ng: Ch∆∞a x√°c ƒë·ªãnh v·ªã tr√≠</div>
        <div id="gridWrapper" style="margin-top:12px">
          <div id="loading" class="loading" style="display:none">ƒêang x√°c ƒë·ªãnh v·ªã tr√≠ v√† t·∫£i g·ª£i √Ω...</div>
          <div class="grid" id="cards"></div>
          <button id="viewMore" class="view-more" onclick="loadMore()">Xem th√™m m√≥n</button>
        </div>

        <div class="controls" style="margin-top:14px">
          <button class="loc-btn" onclick="shuffleSuggestion()">G·ª£i √Ω ng·∫´u nhi√™n</button>
        </div>

        <div class="footer-note">L∆∞u √Ω: ƒë·ªÉ ch·ª©c nƒÉng v·ªã tr√≠ ho·∫°t ƒë·ªông ch√≠nh x√°c, m·ªü trang qua HTTP (v√≠ d·ª•: http://localhost) ho·∫∑c host online.</div>
      </div>

      <div class="right">
        <h3 style="color:var(--accent);margin-top:0">Khuy·∫øn m·∫°i h√¥m nay</h3>
        <div id="promos"></div>
      </div>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const NOMINATIM_BASE = 'https://nominatim.openstreetmap.org'; // public Nominatim endpoint
const USER_AGENT_NOTE = 'an-gi-hom-nay-app-v3'; // Nominatim policy asks for identifiable UA; browsers cannot change UA header, but referer will be sent
// Use sessionStorage for caching geocoding responses to reduce API calls
const GEO_CACHE_KEY = 'an_gi_geo_cache_v3';

/* ---------- Helpers ---------- */
function svgDataURI(text, bg='#fff7f0', fg='#d35400') {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='480' height='320'><rect width='100%' height='100%' fill='${bg}'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='80' fill='${fg}'>${text}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/* ---------- Data (sample, can expand) ---------- */
const DATA = {
  VN: {
    morning:[
      {img:svgDataURI('üçú'), name:'Ph·ªü b√≤', shop:'Ph·ªü Th√¨n', addr:'13 L√≤ ƒê√∫c, H√† N·ªôi', price:'45.000 ƒë', owner:'VN'},
      {img:svgDataURI('ü•ñ'), name:'B√°nh m√¨ tr·ª©ng', shop:'B√°nh m√¨ Ngon', addr:'22 H√†ng B·∫°c, H√† N·ªôi', price:'25.000 ƒë', owner:'VN'},
      {img:svgDataURI('üçö'), name:'X√¥i x√©o', shop:'X√¥i C√¥ H·∫±ng', addr:'Ng√µ 3, H√† N·ªôi', price:'20.000 ƒë', owner:'VN'},
      {img:svgDataURI('‚òï'), name:'C√† ph√™ s·ªØa ƒë√°', shop:'C√† ph√™ H·∫°nh', addr:'H√†ng Gai, H√† N·ªôi', price:'18.000 ƒë', owner:'VN'}
    ],
    lunch:[ /* ... filled in later for demo */ ],
    dinner:[ /* ... */ ],
    promos:[{title:'Gi·∫£m 30% L·∫©u N·∫•m & G√†', shop:'L·∫©u N·∫•m Gia Kh√°nh', misc:'15 Ng√µ 191 L·∫°c Long Qu√¢n', dist:'3.5km'}]
  },
  US:{ /* minimal sample */ },
  JP:{ /* ... */ },
  FR:{ /* ... */ }
};
/* for demo completeness, add some items to lunch/dinner */
DATA.VN.lunch = DATA.VN.morning.concat([
  {img:svgDataURI('üçõ'), name:'C∆°m t·∫•m s∆∞·ªùn', shop:'C∆°m T·∫•m Cali', addr:'Nguy·ªÖn Tr√£i, H√† N·ªôi', price:'55.000 ƒë', owner:'VN'},
  {img:svgDataURI('üçú'), name:'B√∫n ch·∫£', shop:'B√∫n Ch·∫£ H∆∞∆°ng Li√™n', addr:'24 L√™ VƒÉn H∆∞u, H√† N·ªôi', price:'45.000 ƒë', owner:'VN'},
  {img:svgDataURI('üçù'), name:'M√¨ Qu·∫£ng', shop:'M√¨ Qu·∫£ng B√† Mua', addr:'ƒê√† N·∫µng', price:'50.000 ƒë'}
]);
DATA.VN.dinner = DATA.VN.lunch.concat([
  {img:svgDataURI('üç≤'), name:'L·∫©u th√°i', shop:'L·∫©u 5 Sao', addr:'T√¥n Th·∫•t T√πng, H√† N·ªôi', price:'150.000 ƒë/ng', owner:'VN'}
]);

/* ---------- State ---------- */
let pageIndex = 0;
let pageSize = 9;
let currentMeal = 'lunch';
let userLat = null, userLon = null;
let detectedCountry = null;
let manualAddress = '';
let geoCache = {};

/* load cache */
try{ geoCache = JSON.parse(sessionStorage.getItem(GEO_CACHE_KEY) || '{}'); }catch(e){ geoCache = {}; }

/* ---------- Utility math ---------- */
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371; // km
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/* ---------- Nominatim geocoding ---------- */
async function geocodeAddress(addr){
  if(!addr) return null;
  const key = addr.toLowerCase();
  if(geoCache[key]) return geoCache[key];
  const url = `${NOMINATIM_BASE}/search?format=json&limit=1&q=${encodeURIComponent(addr)}&addressdetails=1`;
  try{
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('Kh√¥ng th·ªÉ truy v·∫•n geocoding');
    const j = await res.json();
    if(j && j.length){
      const r = j[0];
      const val = {lat:parseFloat(r.lat), lon:parseFloat(r.lon), address:r.display_name, details:r.address||{}};
      geoCache[key] = val;
      sessionStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
      return val;
    }
    return null;
  }catch(e){
    console.error(e);
    return null;
  }
}

/* ---------- Reverse geocode (from coords) ---------- */
async function reverseGeocode(lat, lon){
  const key = `rev_${lat.toFixed(5)}_${lon.toFixed(5)}`;
  if(geoCache[key]) return geoCache[key];
  const url = `${NOMINATIM_BASE}/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
  try{
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('Reverse geocode failed');
    const j = await res.json();
    if(j){
      const val = {lat:parseFloat(j.lat||lat), lon:parseFloat(j.lon||lon), address:j.display_name, details:j.address||{}};
      geoCache[key] = val;
      sessionStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
      return val;
    }
    return null;
  }catch(e){ console.error(e); return null; }
}

/* ---------- Country detection from Nominatim details or fallback ---------- */
function countryCodeFromDetails(details){
  if(!details) return null;
  // try to get country code if provided
  if(details.country_code) return details.country_code.toUpperCase();
  // else map some fields
  if(details.country) {
    const c = details.country.toLowerCase();
    if(c.includes('vietnam')) return 'VN';
    if(c.includes('japan')) return 'JP';
    if(c.includes('france')) return 'FR';
    if(c.includes('germany')) return 'DE';
    if(c.includes('united')) return 'US';
  }
  return null;
}

/* ---------- Rendering ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  selectMeal('lunch');
  renderPromos();
  updateStatus('Ch∆∞a x√°c ƒë·ªãnh v·ªã tr√≠');
});

function updateStatus(msg){ document.getElementById('status').innerText = 'T√¨nh tr·∫°ng: ' + msg; }

function getEffectiveCountry(){
  if(manualAddress){
    const key = manualAddress;
    const cached = geoCache[key.toLowerCase()];
    if(cached && cached.details) {
      const cc = countryCodeFromDetails(cached.details);
      if(cc) return cc;
    }
    // fallback to detectedCountry if exists
  }
  if(detectedCountry) return detectedCountry;
  // if online, try to detect from browser locale/timezone
  try{
    const lang = (navigator.language||'').toLowerCase();
    if(lang.startsWith('vi')) return 'VN';
    if(lang.startsWith('ja')) return 'JP';
    if(lang.startsWith('fr')) return 'FR';
    if(lang.startsWith('de')) return 'DE';
    if(lang.startsWith('en')) return 'US';
  }catch(e){}
  return 'VN';
}

function highlightTab(meal){
  ['morning','lunch','dinner'].forEach(m=>{
    const el = document.getElementById('tab-'+m);
    if(m===meal) el.classList.add('active'); else el.classList.remove('active');
  });
}

function selectMeal(meal){
  pageIndex = 0;
  currentMeal = meal;
  highlightTab(meal);
  document.getElementById('mealTitle').innerText = meal==='morning'?'Bu·ªïi s√°ng': meal==='lunch'?'Bu·ªïi tr∆∞a':'Bu·ªïi t·ªëi';
  renderCards();
}

/* Render 9 cards per page; prioritize VN-owned when not in VN */
function renderCards(){
  const country = getEffectiveCountry();
  const list = (DATA[country] && DATA[country][currentMeal]) ? DATA[country][currentMeal].slice() : (DATA['VN'][currentMeal]||[]).slice();
  let priority = [];
  if(country !== 'VN'){
    list.forEach(i=>{ if(i.owner==='VN') priority.push(i); });
    if(priority.length===0) priority = (DATA['VN'][currentMeal]||[]).slice(0,2);
  }
  const merged = [...priority, ...list.filter(i=>!priority.includes(i))];
  // compute page
  const start = pageIndex * pageSize;
  const pageItems = merged.slice(start, start+pageSize);
  const container = document.getElementById('cards');
  container.innerHTML = pageItems.map(it=>{
    const dist = computeDistanceString(it);
    return `<div class="card">
      <div class="cardTop"><div class="thumb"><img src="${it.img}" alt="${it.name}" style="width:100%;height:100%;object-fit:cover" /></div>
      <div class="info"><h4>${it.name}</h4><div class="sub">${it.shop} ‚Ä¢ ${it.addr}</div><div class="meta"><div class="dist">${dist}</div><div class="price">${it.price||''}</div></div></div></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <button class="btn-like" onclick="openMaps('${encodeURIComponent(it.shop+' '+it.addr)}')">Maps</button>
        <button style="background:#fff;border:1px solid #eee;padding:8px;border-radius:8px;cursor:pointer" onclick="showDetail('${encodeURIComponent(JSON.stringify(it))}')">Chi ti·∫øt</button>
      </div>
    </div>`;
  }).join('');
  // show/hide view more
  const mergedLength = merged.length;
  document.getElementById('viewMore').style.display = (start + pageSize < mergedLength) ? 'block' : 'none';
}

/* compute distance string using haversine if we have user coords, else random */
function computeDistanceString(item){
  let dKm;
  if(userLat && userLon && item._coords && item._coords.lat && item._coords.lon){
    dKm = haversine(userLat,userLon, item._coords.lat, item._coords.lon);
  } else if(userLat && userLon){
    // bias to nearer distances if user location exists
    dKm = (Math.random()*2.0 + 0.2);
  } else {
    dKm = (Math.random()*3.5 + 0.5);
  }
  if(dKm < 1) return Math.round(dKm*1000) + ' m';
  return dKm.toFixed(1) + ' km';
}

function loadMore(){ pageIndex++; renderCards(); document.getElementById('gridWrapper').scrollIntoView({behavior:'smooth'}); }

function showDetail(encoded){
  try {
    const it = JSON.parse(decodeURIComponent(encoded));
    alert(`${it.name}\n${it.shop}\n${it.addr}\nGi√°: ${it.price || 'Tham kh·∫£o'}${it.owner==='VN' ? '\nQu√°n ng∆∞·ªùi Vi·ªát' : ''}`);
  } catch(e){ console.error(e); }
}

function openMaps(q){
  if(!navigator.onLine){ alert('C·∫ßn k·∫øt n·ªëi Internet ƒë·ªÉ m·ªü b·∫£n ƒë·ªì.'); return; }
  window.open('https://www.google.com/maps/search/?api=1&query='+q,'_blank');
}

/* Promotions panel */
function renderPromos(){
  const country = getEffectiveCountry();
  const promos = (DATA[country] && DATA[country].promos) ? DATA[country].promos : (DATA['VN'].promos || []);
  const cont = document.getElementById('promos');
  cont.innerHTML = promos.map(p=>`<div class="promo"><strong>${p.title}</strong><div class="small">${p.shop} ¬∑ ${p.misc} ¬∑ ${p.dist}</div></div>`).join('') || '<div class="small">Kh√¥ng c√≥ khuy·∫øn m√£i.</div>';
}

/* ---------- Actions: geolocation and manual address ---------- */
async function getUserLocation(){
  if(!navigator.geolocation){ alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã. Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ th·ªß c√¥ng.'); return; }
  updateStatus('ƒêang l·∫•y v·ªã tr√≠...');
  try{
    navigator.geolocation.getCurrentPosition(async pos=>{
      userLat = pos.coords.latitude; userLon = pos.coords.longitude;
      // reverse geocode to find country & address
      const rev = await reverseGeocode(userLat,userLon);
      if(rev){
        detectedCountry = countryCodeFromDetails(rev.details) || detectedCountry;
        manualAddress = rev.address || manualAddress;
        document.getElementById('manualAddress').value = rev.address;
        updateStatus(`ƒê√£ l·∫•y v·ªã tr√≠: ${rev.address}`);
      } else {
        updateStatus(`ƒê√£ l·∫•y t·ªça ƒë·ªô: ${userLat.toFixed(5)}, ${userLon.toFixed(5)}`);
      }
      pageIndex=0; renderCards(); renderPromos();
    }, err=>{
      let msg='Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠.';
      if(err.code===1) msg='B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn v·ªã tr√≠. Vui l√≤ng b·∫≠t quy·ªÅn ho·∫∑c nh·∫≠p ƒë·ªãa ch·ªâ.';
      if(err.code===2) msg='Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. H√£y th·ª≠ nh·∫≠p ƒë·ªãa ch·ªâ th·ªß c√¥ng.';
      if(err.code===3) msg='Y√™u c·∫ßu v·ªã tr√≠ qu√° th·ªùi gian. Th·ª≠ l·∫°i.';
      updateStatus(msg);
      alert(msg);
    }, {enableHighAccuracy:true, timeout:10000});
  }catch(e){
    console.error(e);
    updateStatus('L·ªói khi l·∫•y v·ªã tr√≠');
  }
}

async function useManualAddress(){
  const addr = document.getElementById('manualAddress').value.trim();
  if(!addr){ alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ.'); return; }
  updateStatus('ƒêang t√¨m ƒë·ªãa ch·ªâ...');
  document.getElementById('loading').style.display='block';
  // check cache first
  const cached = geoCache[addr.toLowerCase()];
  if(cached){
    manualAddress = addr;
    detectedCountry = countryCodeFromDetails(cached.details) || detectedCountry;
    if(cached.lat && cached.lon){ userLat = cached.lat; userLon = cached.lon; }
    updateStatus('ƒê√£ x√°c ƒë·ªãnh: ' + (cached.address || addr));
    document.getElementById('loading').style.display='none';
    pageIndex=0; renderCards(); renderPromos();
    return;
  }
  // call Nominatim geocode
  try{
    const g = await geocodeAddress(addr);
    document.getElementById('loading').style.display='none';
    if(!g){
      updateStatus('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ. Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh.');
      alert('Kh√¥ng t√¨m th·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i v·ªõi ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß ho·∫∑c b·∫≠t v·ªã tr√≠ GPS.');
      manualAddress = addr; pageIndex=0; renderCards(); renderPromos();
      return;
    }
    manualAddress = addr;
    detectedCountry = countryCodeFromDetails(g.details) || detectedCountry;
    if(g.lat && g.lon){ userLat = g.lat; userLon = g.lon; }
    updateStatus('ƒê√£ x√°c ƒë·ªãnh: ' + (g.address || addr));
    pageIndex=0; renderCards(); renderPromos();
  }catch(e){
    console.error(e);
    document.getElementById('loading').style.display='none';
    updateStatus('L·ªói khi t√¨m ƒë·ªãa ch·ªâ');
    alert('L·ªói khi t√¨m ƒë·ªãa ch·ªâ. Vui l√≤ng th·ª≠ l·∫°i.');
  }
}

/* ---------- Search and shuffle ---------- */
function shuffleSuggestion(){
  const country = getEffectiveCountry();
  const dataset = DATA[country] || DATA['VN'];
  const pool = [].concat(dataset.morning||[], dataset.lunch||[], dataset.dinner||[]);
  if(!pool.length) return;
  const item = pool[Math.floor(Math.random()*pool.length)];
  document.getElementById('cards').innerHTML = `<div class="card"><div class="cardTop"><div class="thumb"><img src="${item.img}" style="width:100%;height:100%;object-fit:cover" /></div><div class="info"><h4>${item.name}</h4><div class="sub">${item.shop} ‚Ä¢ ${item.addr}</div><div class="meta"><div class="dist">${computeDistanceString(item)}</div><div class="price">${item.price||''}</div></div></div></div><div style="display:flex;justify-content:space-between;align-items:center"><button class="btn-like" onclick="openMaps('${encodeURIComponent(item.shop+' '+item.addr)}')">Maps</button></div></div>`;
  document.getElementById('viewMore').style.display='none';
}

/* ---------- Utilities ---------- */
function refreshAll(){
  manualAddress=''; document.getElementById('manualAddress').value=''; detectedCountry = detectCountryCode(); pageIndex=0; renderCards(); renderPromos(); updateStatus('Ch∆∞a x√°c ƒë·ªãnh v·ªã tr√≠');
}

/* ---------- Small detector fallback ---------- */
function detectCountryCode(){
  try{
    const lang = (navigator.language||'').toLowerCase();
    const tz = (Intl && Intl.DateTimeFormat) ? Intl.DateTimeFormat().resolvedOptions().timeZone || '' : '';
    if(lang.startsWith('vi')) return 'VN';
    if(lang.startsWith('ja')) return 'JP';
    if(lang.startsWith('fr')) return 'FR';
    if(lang.startsWith('de')) return 'DE';
    if(lang.startsWith('en')){
      if(tz.includes('Tokyo')) return 'JP';
      if(tz.includes('Paris')) return 'FR';
      if(tz.includes('America/')) return 'US';
      return 'US';
    }
    if(tz.includes('Asia/Tokyo')) return 'JP';
    if(tz.includes('Europe/Paris')) return 'FR';
    return 'VN';
  }catch(e){ return 'VN'; }
}

</script>
</body>
</html>
